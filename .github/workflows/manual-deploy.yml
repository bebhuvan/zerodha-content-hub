name: Manual Deploy with All Newsletters

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'Deployment message'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Fetch RSS feeds
        run: npm run fetch-feeds
      
      - name: Verify all newsletters are present
        run: |
          echo "ðŸ“Š Content Statistics:"
          cat src/data/stats.json
          echo ""
          echo "ðŸ“„ Newsletter sources:"
          cat src/data/content.json | jq '[.[] | select(.type == "newsletter") | .source] | group_by(.) | map({source: .[0], count: length})'
      
      - name: Build Astro site
        run: npm run build
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: zerodha-content-hub
          directory: dist
          wranglerVersion: '3'
      
      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“„ Newsletter verification:"
          cat dist/content.json | jq '[.[] | select(.type == "newsletter")] | length' | xargs echo "Total newsletters in build:"