---
import Layout from '../../layouts/Layout.astro';
import ContentList from '../../components/ContentList.astro';
import { readFileSync } from 'fs';
import { join } from 'path';

export async function getStaticPaths() {
  try {
    const contentPath = join(process.cwd(), 'src', 'data', 'content.json');
    const contentData = JSON.parse(readFileSync(contentPath, 'utf8')) as any[];
    
    // Get unique sources
    const sources = [...new Set(contentData.map((item: any) => item.source))];
    
    return sources.map((source: string) => ({
      params: { source: source.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') },
      props: { 
        sourceName: source,
        content: contentData.filter((item: any) => item.source === source)
      }
    }));
  } catch (error) {
    console.error('Error generating static paths:', error);
    return [];
  }
}

const { source } = Astro.params;
const { sourceName, content } = Astro.props;

// If no content found, return 404
if (!content || content.length === 0) {
  return Astro.redirect('/404');
}

const sourceInfo: Record<string, any> = {
  'Z-Connect Blog': {
    type: 'Blog',
    description: 'Market insights, IPO analysis, and investment guides from Zerodha\'s research team',
    icon: 'ğŸ“'
  },
  'Varsity Blog': {
    type: 'Blog', 
    description: 'Educational articles on trading, investing, and financial markets fundamentals',
    icon: 'ğŸ“'
  },
  'Daily Brief': {
    type: 'Newsletter',
    description: 'Daily market wrap-up and analysis of key economic stories affecting Indian markets',
    icon: 'ğŸ“§'
  },
  'The Daily Brief Podcast': {
    type: 'Podcast',
    description: 'Audio version of The Daily Brief with detailed discussions on market trends',
    icon: 'ğŸ™ï¸'
  },
  'Side Notes by Zerodha Varsity': {
    type: 'Podcast',
    description: 'Educational podcast covering personal finance and investing concepts',
    icon: 'ğŸ“š'
  },
  'Investing in India': {
    type: 'Podcast',
    description: 'Insights into India\'s investment landscape and business opportunities',
    icon: 'ğŸ‡®ğŸ‡³'
  },
  'After Market Report': {
    type: 'Newsletter',
    description: 'Quick daily wrap-up of what happened in Indian and global markets',
    icon: 'ğŸ“ˆ'
  },
  'The Chatter': {
    type: 'Newsletter',
    description: 'Weekly insights and commentary on market trends and technology',
    icon: 'ğŸ’¬'
  },
  'Varsity Newsletter': {
    type: 'Newsletter',
    description: 'Educational content on personal finance and investing fundamentals',
    icon: 'ğŸ“'
  },
  'What The Hell Is Happening': {
    type: 'Newsletter',
    description: 'Unconventional takes on current events and markets with humor',
    icon: 'ğŸ¤¯'
  },
  'Markets': {
    type: 'Video',
    description: 'Educational videos covering market analysis and trading strategies',
    icon: 'ğŸ“º'
  },
  'Zerodha': {
    type: 'Video',
    description: 'Daily market outlook and technical analysis for NIFTY and Bank NIFTY',
    icon: 'ğŸ“Š'
  },
  'Zero1': {
    type: 'Video',
    description: 'Quick market updates and financial literacy in short-form videos',
    icon: 'âš¡'
  },
  'Varsity': {
    type: 'Video',
    description: 'Educational content covering personal finance and investment basics',
    icon: 'ğŸ“'
  }
};

const info = sourceInfo[sourceName] || {
  type: 'Content',
  description: `Content from ${sourceName}`,
  icon: 'ğŸ“„'
};

const title = `${sourceName} - Market Insights by Zerodha`;
const description = `${info.description} - ${content.length} items available`;
---

<Layout title={title} description={description}>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 md:px-8 lg:px-12">
    <!-- Header -->
    <header class="pt-8 pb-8 border-b border-gray-100">
      <!-- Back Navigation -->
      <div class="mb-6">
        <a href="/sources" class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-black transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Back to Sources
        </a>
      </div>

      <!-- Source Header -->
      <div class="text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
          <span class="text-4xl">{info.icon}</span>
          <div>
            <h1 class="text-3xl font-bold text-gray-900">{sourceName}</h1>
            <span class="inline-block px-3 py-1 text-sm font-medium bg-gray-100 text-gray-600 rounded-full mt-2">
              {info.type}
            </span>
          </div>
        </div>
        
        <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-4">
          {info.description}
        </p>
        
        <div class="text-sm text-gray-500">
          {content.length} item{content.length !== 1 ? 's' : ''} available
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="py-8">
      <div id="source-content" data-source={sourceName}>
        <ContentList />
      </div>
    </main>
  </div>

  <script define:vars={{ sourceContent: content, sourceName }}>
    // Make the content available for filtering
    window.sourcePageContent = sourceContent;
    window.sourcePageName = sourceName;
    
    // Override the content loading for this source page
    document.addEventListener('DOMContentLoaded', function() {
      // Dispatch event to load source-specific content
      window.dispatchEvent(new CustomEvent('source-page-loaded', {
        detail: { content: sourceContent, source: sourceName }
      }));
    });
  </script>
</Layout>